<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PC-G815 Compatible Z80 Emulator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet" />
  </head>
  <body>
    <div class="app-shell">
      <header class="hero">
        <h1>PC-G815 Compatible Z80 Emulator</h1>
        <p>T-state stepped core, matrix keyboard mapping, and Canvas2D LCD renderer.</p>
        <p><a href="https://github.com/yappo/z80emuweb" target="_blank">https://github.com/yappo/z80emuweb</a></p>
      </header>

      <main class="panel-grid">
        <section class="device-panel">
          <div class="device-body">
            <div class="device-top">
              <span class="brand">SHARP STYLE</span>
              <span id="boot-status" class="boot-status" role="status" aria-live="polite">BOOTING</span>
              <span id="speed-indicator">0.00x</span>
            </div>
            <div class="lcd-bezel">
              <div class="lcd-screen">
                <canvas id="lcd" width="480" height="128" aria-label="PC-G815 LCD"></canvas>
              </div>
            </div>
            <div class="controls" role="group" aria-label="Emulator controls">
              <button id="run-toggle" type="button">Stop</button>
              <button id="step" type="button">Step</button>
              <button id="reset" type="button">Reset</button>
              <button id="kana-toggle" type="button" aria-pressed="false">かな OFF</button>
              <button id="font-debug-toggle" type="button" aria-expanded="false" aria-controls="font-debug-panel">
                Fonts
              </button>
            </div>
          </div>
        </section>

        <section class="status-panel">
          <div class="editor-tabs" role="tablist" aria-label="Editor mode tabs">
            <button id="editor-tab-basic" class="editor-tab" role="tab" aria-selected="true" aria-controls="basic-editor-panel">
              BASIC
            </button>
            <button id="editor-tab-asm" class="editor-tab" role="tab" aria-selected="false" aria-controls="asm-editor-panel">
              ASSEMBLER
            </button>
          </div>

          <section id="basic-editor-panel" class="basic-editor-panel" aria-label="BASIC editor">
            <div class="basic-editor-head">
              <h2>BASIC Editor</h2>
              <span id="basic-run-status" class="basic-run-status" role="status" aria-live="polite">Idle</span>
            </div>
            <p class="basic-editor-hint">
              Editor focus: keyboard input types into this editor. Outside editor focus: keys control the emulator.
              RUN executes: NEW -> program lines -> RUN.
            </p>
            <p class="basic-editor-ref">
              Language reference:
              <a
                href="https://github.com/yappo/z80emuweb/blob/main/docs/basic-language-spec.md"
                target="_blank"
                rel="noopener noreferrer"
                >basic-language-spec.md</a
              >
            </p>
            <div class="basic-editor-controls" role="group" aria-label="BASIC editor controls">
              <button id="basic-run" type="button">RUN Program</button>
              <button id="basic-stop" type="button">STOP CPU</button>
              <button id="basic-new" type="button">NEW</button>
              <button id="basic-load-sample" type="button">Load Sample</button>
              <button id="basic-load-game" type="button">Sample Game</button>
            </div>
            <div class="basic-editor-body">
              <pre id="basic-editor-lines" class="basic-editor-lines" aria-hidden="true">1</pre>
              <textarea
                id="basic-editor"
                class="basic-editor"
                spellcheck="false"
                autocapitalize="off"
                autocomplete="off"
                aria-label="BASIC source editor"
              >10 A = 1
20 PRINT A
30 A = A + 1
40 WAIT 64
50 IF A > 10 THEN 70
60 GOTO 20
70 PRINT "owari"
80 END</textarea>
            </div>
          </section>

          <section id="asm-editor-panel" class="basic-editor-panel asm-editor-panel" aria-label="Assembler editor" hidden>
            <div class="basic-editor-head">
              <h2>Z80 Assembler</h2>
              <span id="asm-run-status" class="basic-run-status" role="status" aria-live="polite">Idle</span>
            </div>
            <p class="basic-editor-hint">
              Assemble generates machine code with ORG/ENTRY. Run loads assembled bytes into RAM and starts execution at ENTRY.
              After ASM RUN, if the machine does not return to normal interactive state, press Reset.
            </p>
            <p class="basic-editor-ref">
              Language reference:
              <a
                href="https://github.com/yappo/z80emuweb/blob/main/docs/assembly-language-spec.md"
                target="_blank"
                rel="noopener noreferrer"
                >assembly-language-spec.md</a
              > /
              <a
                href="https://github.com/yappo/z80emuweb/blob/main/docs/z80-assembly-mnemonics.md"
                target="_blank"
                rel="noopener noreferrer"
                >z80-assembly-mnemonics.md</a
              >
            </p>
            <div class="basic-editor-controls" role="group" aria-label="Assembler editor controls">
              <button id="asm-assemble" type="button">ASSEMBLE</button>
              <button id="asm-run" type="button">RUN</button>
              <button id="asm-stop" type="button">STOP CPU</button>
              <button id="asm-new" type="button">NEW</button>
              <button id="asm-load-sample" type="button">Load Sample</button>
            </div>
            <div class="basic-editor-body">
              <pre id="asm-editor-lines" class="basic-editor-lines" aria-hidden="true">1</pre>
              <textarea
                id="asm-editor"
                class="basic-editor"
                spellcheck="false"
                autocapitalize="off"
                autocomplete="off"
                aria-label="Assembler source editor"
              >ORG 0x0200
ENTRY START

START:
  LD A,0x40
  OUT (0x58),A
  LD A,0x80
  OUT (0x58),A
  LD HL,PROMPT_IN
  CALL PRINT_STR

  LD HL,BUFFER
  XOR A
  LD (LEN),A

READ_LOOP:
  PUSH HL
  CALL READ_KEY
  POP HL
  CP 0x0D
  JR Z,INPUT_DONE
  CP 0x08
  JR Z,HANDLE_BS

  LD C,A
  LD A,(LEN)
  CP 24
  JR NC,READ_LOOP
  LD A,C
  LD (HL),A
  INC HL
  LD A,(LEN)
  INC A
  LD (LEN),A
  LD A,C
  OUT (0x5A),A
  JR READ_LOOP

HANDLE_BS:
  LD A,(LEN)
  OR A
  JR Z,READ_LOOP
  DEC HL
  DEC A
  LD (LEN),A
  LD A,0x08
  OUT (0x5A),A
  JR READ_LOOP

INPUT_DONE:
  LD A,0x0D
  OUT (0x5A),A
  LD A,0x0A
  OUT (0x5A),A
  LD HL,PROMPT_OUT
  CALL PRINT_STR

  LD A,(LEN)
  OR A
  JR Z,PRINT_EOL
  LD B,A
  LD HL,BUFFER
  LD E,A
  LD D,0
  ADD HL,DE
  DEC HL

REV_LOOP:
  LD A,(HL)
  OUT (0x5A),A
  DEC HL
  DJNZ REV_LOOP

PRINT_EOL:
  LD A,0x0D
  OUT (0x5A),A
  LD A,0x0A
  OUT (0x5A),A

DONE:
  RET

PRINT_STR:
  LD A,(HL)
  OR A
  RET Z
  OUT (0x5A),A
  INC HL
  JR PRINT_STR

READ_KEY:
WAIT_CLEAR:
  CALL SCAN_KEY
  JR NZ,WAIT_CLEAR
WAIT_PRESS:
  CALL SCAN_KEY
  JR Z,WAIT_PRESS
  RET

SCAN_KEY:
  LD A,0x80
  OUT (0x11),A
  IN A,(0x10)
  LD B,0
  BIT 0,A
  JR Z,SHIFT_ON
  BIT 1,A
  JR NZ,SHIFT_DONE
SHIFT_ON:
  LD B,1
SHIFT_DONE:
  LD C,0x01
  LD D,0x00

SCAN_ROW:
  LD A,C
  OUT (0x11),A
  IN A,(0x10)
  CPL
  AND 0xFF
  JR NZ,ROW_HIT
  INC D
  SLA C
  JR NZ,SCAN_ROW
  XOR A
  RET

ROW_HIT:
  LD E,0
  BIT 0,A
  JR NZ,COL_FOUND
  INC E
  BIT 1,A
  JR NZ,COL_FOUND
  INC E
  BIT 2,A
  JR NZ,COL_FOUND
  INC E
  BIT 3,A
  JR NZ,COL_FOUND
  INC E
  BIT 4,A
  JR NZ,COL_FOUND
  INC E
  BIT 5,A
  JR NZ,COL_FOUND
  INC E
  BIT 6,A
  JR NZ,COL_FOUND
  INC E
  BIT 7,A
  JR NZ,COL_FOUND
  XOR A
  RET

COL_FOUND:
  LD A,D
  ADD A,A
  ADD A,A
  ADD A,A
  ADD A,E
  LD E,A
  LD D,0
  LD HL,NORMAL_TABLE
  LD A,B
  OR A
  JR Z,TABLE_OK
  LD HL,SHIFT_TABLE
TABLE_OK:
  ADD HL,DE
  LD A,(HL)
  OR A
  RET

PROMPT_IN:
  DB "Input Word: ",0
PROMPT_OUT:
  DB "Reversed: ",0
LEN:
  DB 0
BUFFER:
  DS 24,0

NORMAL_TABLE:
  DB 0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48
  DB 0x49,0x4A,0x4B,0x4C,0x4D,0x4E,0x4F,0x50
  DB 0x51,0x52,0x53,0x54,0x55,0x56,0x57,0x58
  DB 0x59,0x5A,0x3B,0x27,0x5B,0x5D,0x5C,0x60
  DB 0x09,0x1B,0x08,0x00,0x00,0x00,0x00,0x00
  DB 0x37,0x38,0x39,0x2D,0x3D,0x2C,0x2E,0x2F
  DB 0x00,0x30,0x31,0x32,0x33,0x34,0x35,0x36
  DB 0x00,0x00,0x0D,0x08,0x20,0x00,0x00,0x00

SHIFT_TABLE:
  DB 0x61,0x62,0x63,0x64,0x65,0x66,0x67,0x68
  DB 0x69,0x6A,0x6B,0x6C,0x6D,0x6E,0x6F,0x70
  DB 0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78
  DB 0x79,0x7A,0x3A,0x22,0x7B,0x7D,0x7C,0x7E
  DB 0x09,0x1B,0x08,0x00,0x00,0x00,0x00,0x00
  DB 0x26,0x2A,0x28,0x5F,0x2B,0x3C,0x3E,0x3F
  DB 0x00,0x29,0x21,0x40,0x23,0x24,0x25,0x5E
  DB 0x00,0x00,0x0D,0x08,0x20,0x00,0x00,0x00
</textarea>
            </div>
            <h3>Machine Dump</h3>
            <pre id="asm-dump-view" class="debug-view asm-dump-view"></pre>
          </section>

          <h2>Status</h2>
          <pre id="debug-view" class="debug-view" hidden></pre>
          <h3>Input Log</h3>
          <pre id="log-view" class="log-view"></pre>
          <h3>Key Matrix Map</h3>
          <div id="keymap-list" class="keymap-list"></div>
          <section id="font-debug-panel" class="font-debug-panel" hidden>
            <div class="font-debug-head">
              <h3>Font 5x7 Atlas</h3>
              <span id="font-debug-meta" class="font-debug-meta">0x41 "A"</span>
            </div>
            <p class="font-debug-hint">Click a cell to inspect glyph code (0x00-0xFF).</p>
            <canvas id="font-debug-canvas" aria-label="Font 5x7 glyph atlas"></canvas>
            <h4 class="font-kana-title">A0-DF Zoom</h4>
            <canvas id="font-kana-canvas" aria-label="Kana glyph zoom"></canvas>
          </section>
        </section>
      </main>
    </div>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
